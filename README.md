# TTS文本过滤插件

一个智能的AstrBot TTS文本过滤插件，专门用于清理不适合语音朗读的内容，让TTS输出更加自然流畅。

## ✨ 主要特性

- **🎭 颜文字过滤**: 自动移除 `(＾_＾)`, `(>_<)`, `o_o` 等颜文字
- **🎨 特殊符号清理**: 过滤 ★♪♥💖→ 等装饰性符号和表情符号
- **🔄 智能替换**: `233` → `哈哈哈`, `666` → `厉害`, `555` → `呜呜呜`
- **🗑️ 直接过滤**: 完全移除 `orz`, `QAQ`, `TAT` 等不适合朗读的词汇
- **📝 重复字符压缩**: `哈哈哈哈哈` → `哈哈` (可配置保留数量)
- **📏 字数限制**: 超过指定字数自动跳过TTS朗读
- **⚙️ 灵活配置**: 支持正则表达式自定义过滤规则
- **🔧 实时调试**: 可开启调试模式查看详细过滤过程
- **📊 状态监控**: 提供测试命令和统计信息

## 🚀 快速开始

### 安装方法
1. 将插件文件放入AstrBot的插件目录
2. 重启AstrBot或使用插件管理功能加载
3. 插件会自动启用，使用默认配置即可开始工作

### 基本使用
插件安装后会自动工作，无需额外配置。当机器人回复包含不适合TTS的内容时，会自动进行过滤：

**原始回复**: `你好(＾_＾)这是测试233哈哈哈哈♪`  
**过滤后**: `你好这是测试哈哈哈哈`

## 🎮 命令使用

### 测试命令
```
/tts_filter_test [测试文本]
```
测试过滤效果，查看处理前后的对比。

**示例**:
```
/tts_filter_test 你好(＾_＾)这是测试233哈哈哈哈♪

📝 原文 (15 字符):
你好(＾_＾)这是测试233哈哈哈哈♪

🔧 过滤后 (9 字符):
你好这是测试哈哈哈哈

⚙️ 当前配置:
• 直接过滤: orz, QAQ, TAT等
• 替换规则: 233→哈哈哈, 666→厉害等

📊 处理结果:
• 字符压缩率: 40.0%
• TTS状态: ✅ 可朗读

🔄 新机制说明:
• 原始消息保持不变，仅TTS使用过滤后的内容
• 避免了文本恢复的时机问题
• 更稳定可靠的过滤机制
```

### 状态查看
```
/tts_filter_stats
```
查看插件运行状态和当前配置信息。

### 配置重载
```
/tts_filter_reload
```
重新加载配置文件，使配置修改立即生效。

## ⚙️ 配置说明

插件支持通过AstrBot配置面板进行设置，主要配置项包括：

### 基础设置
- **启用过滤** (`enabled`): 总开关，控制是否启用过滤功能
- **最大朗读字数** (`max_length`): 超过此字数将跳过TTS (0=无限制)
- **最大处理长度** (`max_processing_length`): 超过此长度将跳过过滤，防止处理超长文本
- **调试模式** (`debug_mode`): 是否输出详细的处理日志

### 过滤规则
- **颜文字过滤规则** (`emoticon_patterns`): 正则表达式列表，匹配需要过滤的颜文字
- **直接过滤词汇** (`filter_words`): 完全不朗读的词汇列表
- **替换词汇配置** (`replacement_words`): 替换规则，格式为"原词|替换词"
- **特殊符号过滤** (`filter_special_chars`): 是否过滤装饰性符号和表情
- **重复字符处理** (`filter_repeats`): 是否压缩重复字符
- **最大重复数量** (`max_repeat_count`): 保留的最大重复字符数量

### 默认配置
```json
{
  "enabled": true,
  "max_length": 200,
  "max_processing_length": 10000,
  "emoticon_patterns": [
    "[（(][^（()]*[）)]",
    "[＞>][＿_][＜<]",
    "[＾^][＿_][＾^]",
    "[oO][＿_][oO]",
    "[xX][＿_][xX]",
    "[－-][＿_][－-]",
    "[（(][；;][＿_][；;][）)]"
  ],
  "filter_words": ["orz", "OTZ", "QAQ", "QWQ", "TAT", "TUT"],
  "replacement_words": [
    "233|哈哈哈",
    "666|厉害", 
    "999|很棒",
    "6|厉害",
    "555|呜呜呜"
  ],
  "filter_special_chars": true,
  "special_char_patterns": [
    "[★☆♪♫♬♩♡♥❤️💖💕💗💓💝💟💜💛💚💙🧡🤍🖤🤎💔❣️💋]",
    "[→←↑↓↖↗↘↙↔↕↺↻]"
  ],
  "filter_repeats": true,
  "max_repeat_count": 2,
  "debug_mode": false
}
```

## 🔧 工作原理

### 过滤流程
```
LLM回复 → 创建消息链副本 → 文本过滤 → 字数检查 → TTS合成
           ↓                    ↓
    原始消息保持不变        应用所有过滤规则:
    用户看到原始内容        1. 颜文字移除 (正则匹配)
                          2. 直接过滤词汇移除
                          3. 词汇替换 (网络用语转换)
                          4. 特殊符号移除 (表情符号等)
                          5. 重复字符压缩
                          6. 多余空格清理
```

### 新机制优势
- **消息链副本**: 为TTS创建过滤后的消息链副本，原始消息完全不变
- **无恢复风险**: 完全避免文本恢复的时机问题
- **更稳定**: 使用AstrBot的消息链机制，符合框架设计理念
- **智能存储**: 多种方式存储过滤后的内容，确保TTS能正确读取

### 拦截机制
- 使用 `@filter.on_decorating_result()` 在TTS插件处理前拦截
- 优先级设置为 -1001，确保在TTS插件之前执行
- 创建消息链副本进行过滤，原始消息链保持不变
- 将过滤后的内容存储到事件上下文中，供TTS插件使用

### 智能处理
- **分离模式**: 支持直接过滤（完全移除）和替换朗读两种模式
- **字数控制**: 超过限制字数的文本自动跳过TTS
- **性能优化**: 处理时间超过0.1秒会记录警告日志
- **错误处理**: 配置编译失败时自动回退到默认配置
- **回退机制**: 如果存储失败，使用直接修改消息链的回退方案

## 🐛 故障排除

### 常见问题

**Q: 过滤不生效怎么办？**
A: 检查插件是否启用，使用 `/tts_filter_stats` 查看状态，确认配置正确。

**Q: 配置修改后不生效？**
A: 使用 `/tts_filter_reload` 重新加载配置，或重启AstrBot。

**Q: 正则表达式报错？**
A: 检查配置中的正则表达式语法，可以使用在线正则测试工具验证。

### 调试方法
1. 开启调试模式查看详细日志
2. 使用测试命令验证过滤效果
3. 检查统计信息确认插件运行状态
4. 查看AstrBot日志中的错误信息

## 📈 性能优化

- **高效正则**: 使用编译后的正则表达式提高匹配速度
- **智能跳过**: 空文本或超长文本直接跳过处理
- **内存优化**: 及时清理临时变量，避免内存泄漏
- **异步处理**: 使用异步方法，不阻塞主线程

## 🔄 版本历史

- **v0.3** (当前版本)
  - 🚀 **重大改进**: 使用消息链副本机制，完全避免文本恢复时机问题
  - 🔧 **架构优化**: 原始消息保持不变，仅TTS使用过滤后的内容
  - ⚙️ **配置增强**: 添加最大处理长度配置项，提高灵活性
  - 📊 **代码规范**: 修复导入语句位置，符合PEP 8规范
  - 🛡️ **稳定性提升**: 使用AstrBot消息链机制，更稳定可靠
  - 🔄 **回退机制**: 多种存储方式，确保兼容性

- **v0.2**
  - 分离过滤和替换功能
  - 优化配置界面和错误处理
  - 移除数据持久化，简化架构
  - 添加详细的调试和统计功能
  - 改进正则表达式匹配性能

- **v0.1** 
  - 初始版本，基础过滤功能

## 📝 许可证

MIT License - 详见 [LICENSE](LICENSE) 文件

## 🤝 贡献

欢迎提交Issue和Pull Request来改进这个插件！

## 📞 支持

如有问题，请通过以下方式获取帮助：
- 提交GitHub Issue
- 查看AstrBot官方文档
- 使用插件内置的测试和统计命令
